CREATE OR REPLACE STREAM "INITIAL_STREAM" (
    CD_ESTACAO VARCHAR(4),
    DT_MEDICAO VARCHAR(16),
    DC_NOME VARCHAR(16),
    HR_MEDICAO INTEGER,
    LATITUDE DOUBLE,
    LONGITUDE DOUBLE,
    TEM_MAX DECIMAL(1,1)
);

CREATE OR REPLACE STREAM "inmet-exit-data-proj4" (
    CD_ESTACAO VARCHAR(4),
    DT_MEDICAO VARCHAR(16),
    DC_NOME VARCHAR(16),
    HR_MEDICAO INTEGER,
    LATITUDE DOUBLE,
    LONGITUDE DOUBLE,
    TEM_MAX DECIMAL(1,1)
);

CREATE OR REPLACE STREAM "INTERMEDIATE_STREAM_TEMP_MAX" (
    CD_ESTACAO VARCHAR(4),
    DT_MEDICAO VARCHAR(16),
    DC_NOME VARCHAR(16),
    HR_MEDICAO INTEGER,
    LATITUDE DOUBLE,
    LONGITUDE DOUBLE,
    TEM_MAX DECIMAL(1,1)
);

CREATE OR REPLACE PUMP "PUMP_INITIAL_STREAM" AS
INSERT INTO "INITIAL_STREAM"
    SELECT STREAM
    SOURCE.CD_ESTACAO,
    SOURCE.DT_MEDICAO,
    SOURCE.DC_NOME,
    SOURCE.HR_MEDICAO,
    SOURCE.LATITUDE,
    SOURCE.LONGITUDE,
    SOURCE.TEM_MAX
    FROM SOURCE_SQL_STREAM_001 AS SOURCE
LEFT JOIN REFERENCE_DATA AS REF_DATA
ON SOURCE.DT_MEDICAO = REF_DATA.DT_MEDICAO;

CREATE OR REPLACE PUMP "PUMP_TEMP_MAX" AS 
INSERT INTO "INTERMEDIATE_STREAM_TEMP_MAX" (
    ROWTIME,
    CD_ESTACAO,
    DT_MEDICAO,
    DC_NOME,
    HR_MEDICAO,
    LATITUDE,
    LONGITUDE,
    TEM_MAX
    )
SELECT STREAM 
    FLOOR(SOURCE.ROWTIME TO HOUR),
    SOURCE.CD_ESTACAO,
    SOURCE.DT_MEDICAO,
    SOURCE.DC_NOME,
    SOURCE.HR_MEDICAO,
    SOURCE.LATITUDE,
    SOURCE.LONGITUDE,
    SOURCE.TEM_MAX
    FROM 
    INITIAL_STREAM AS SOURCE
    GROUP BY
    SOURCE.ROWTIME,
    SOURCE.CD_ESTACAO,
    SOURCE.DT_MEDICAO,
    SOURCE.DC_NOME,
    SOURCE.HR_MEDICAO,
    SOURCE.LATITUDE,
    SOURCE.LONGITUDE,
    SOURCE.TEM_MAX,
    FLOOR(SOURCE.ROWTIME TO HOUR)
ORDER BY
FLOOR(SOURCE.ROWTIME TO HOUR),
TEM_MAX DESC;

-- FINAL STREAM
CREATE OR REPLACE PUMP "PUMP_FINAL_STREAM" AS 
INSERT INTO "inmet-exit-data-proj4" 
SELECT STREAM *
FROM
INTERMEDIATE_STREAM_TEMP_MAX;